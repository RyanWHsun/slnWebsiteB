@model prjWebsiteB.ViewModels.ProductViewModel
@{
    ViewData["Title"] = "Edit";
}
@section Styles
{
    <style>
        .content {
            margin: 20px;
            padding-left: 50px;
        }

        .image-container img {
            cursor: pointer;
        }

        #imageUpload1, #imageUpload2, #imageUpload3 {
            display: none; /* 隱藏文件選擇器 */
        }

    </style>
}
<h1>Edit</h1>

<h4>TProduct</h4>
<hr />
<div class="row content">
    <div class="col-md-4">
        <form asp-action="Edit" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="FProductId" />
            <div class="form-group">
                <label asp-for="FUserId" class="control-label"></label>
                <select asp-for="FUserId" class="form-control" asp-items="ViewBag.FUserId" disabled="disabled"></select>
                <span asp-validation-for="FUserId" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="FProductCategoryId" class="control-label"></label>
                <select asp-for="FProductCategoryId" class="form-control" asp-items="ViewBag.FProductCategoryId"></select>
                <span asp-validation-for="FProductCategoryId" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="FProductName" class="control-label"></label>
                <input asp-for="FProductName" class="form-control" />
                <span asp-validation-for="FProductName" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="FProductDescription" class="control-label"></label>
                <input asp-for="FProductDescription" class="form-control" />
                <span asp-validation-for="FProductDescription" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="FProductPrice" class="control-label"></label>
                <input asp-for="FProductPrice" class="form-control" />
                <span asp-validation-for="FProductPrice" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="FIsOnSale" class="control-label"></label>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" asp-for="FIsOnSale" value="true" id="isOnSale1" />
                    <label class="form-check-label" for="isOnSale1">上架</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" asp-for="FIsOnSale" value="false" id="isOnSale0" />
                    <label class="form-check-label" for="isOnSale0">下架</label>
                </div>
                <span asp-validation-for="FIsOnSale" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="FStock" class="control-label"></label>
                <input asp-for="FStock" class="form-control" />
                <span asp-validation-for="FStock" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="FImage" class="control-label">Product Image</label>
                <div id="imagesContainer1" class="image-container">
                    <img id="img1" src="~/img/No_Pic_Tao.jpg" class="img-thumbnail" alt="Default Image" />
                </div>
                <div id="imagesContainer2" class="image-container">
                    <img id="img2" src="~/img/No_Pic_Tao.jpg" class="img-thumbnail" alt="Default Image" />
                </div>
                <div id="imagesContainer3" class="image-container">
                    <img id="img3" src="~/img/No_Pic_Tao.jpg" class="img-thumbnail" alt="Default Image" />
                </div>
                <span asp-validation-for="FImage" class="text-danger"></span>
            </div>
            <!-- 文件選擇器，隱藏 -->
            <input type="file" id="imageUpload1" name="imageUpload1" accept="image/*" style="display: none;" />
            <input type="file" id="imageUpload2" name="imageUpload2" accept="image/*" style="display: none;" />
            <input type="file" id="imageUpload3" name="imageUpload3" accept="image/*" style="display: none;" />
             <div class="form-group">
                <input type="submit" value="Save" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts
{
    <script>
        var baseAddress = window.location.origin;
        var updatedImages = {}; // 定義更新圖片對象

        $(document).ready(function() {
            var p = encodeURI('@Model.FProductId');
            $.ajax({
                url: `${baseAddress}/TProducts/GetPictures/${p}`,
                type: 'GET',
                dataType: 'json' // 確保 jQuery 期望接收 JSON 數據
            })
            .done(data => {
                var containers = ['#imagesContainer1', '#imagesContainer2', '#imagesContainer3'];
                for (var i = 0; i < containers.length; i++) {
                    if (data && data.length > i) {
                        $(`${containers[i]} img`).attr('src', 'data:image/jpeg;base64,' + data[i]);
                    }
                }
            })
            .fail(err => {
                alert('Failed to load images');
            });

            // 綁定圖片容器的雙擊事件
            $('#imagesContainer1, #imagesContainer2, #imagesContainer3').on('dblclick', function() {
                var imageId = $(this).attr('id').replace('imagesContainer', '');
                $(`#imageUpload${imageId}`).click();
            });

            // 處理選擇新圖片事件
            $('#imageUpload1, #imageUpload2, #imageUpload3').on('change', function() {
                var imageId = this.id.replace('imageUpload', '');
                var reader = new FileReader();
                reader.onload = function(e) {
                    $(`#imagesContainer${imageId} img`).attr('src', e.target.result);
                    // 保存更新的圖片到對象中，以便後續提交使用
                    updatedImages[imageId] = e.target.result;
                }
                reader.readAsDataURL(this.files[0]);
            });

            // 處理表單提交事件
            $('form').on('submit', function(e) {
                e.preventDefault(); // 防止表單提交的默認行為

                var formData = new FormData(this);

                // 將更新的圖片添加到表單數據中
                Object.keys(updatedImages).forEach(function(key) {
                    formData.append(`updatedImages[${key}]`, updatedImages[key]);
                });
                $.ajax({
                    url: this.action,
                    type: this.method,
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        alert('數據已成功更新');
                        window.location.href = '@Url.Action("Index")'; // 重定向到索引頁面
                    },
                    error: function(err) {
                        alert('數據更新失敗');
                    }
                });

                
            });
        });
    </script>
}